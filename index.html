<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Time Sense</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.js"></script>
    <script>
      const dataset = [];
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
      }

      body {
        overflow-x: hidden;
      }

      #debug {
        display: none;
      }

      #app {
        text-align: center;
        width: 100%;
        height: 100%;
        padding: 2em;
        box-sizing: border-box;
      }

      #app svg {
        height: 100%;
      }

      #app #clock {
        font: serif;
        font-size: 0.1px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <svg viewBox="-1 -1 2 2">
        <defs>
          <filter id="drop-shadow">
            <feGaussianBlur in="SourceAlpha" stdDeviation="0.02"/>
            <feOffset dx="0" dy="0" result="offsetblur"/>
            <feComponentTransfer>
              <feFuncA type="linear" slope="0.5"/>
            </feComponentTransfer>
            <feMerge>
              <feMergeNode/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <g id="debug">
          <circle cx="-1.0" cy="-1.0" r="0.02" fill="black" />
          <circle cx="-0.5" cy="-1.0" r="0.02" fill="black" />
          <circle cx="0.0"  cy="-1.0" r="0.02" fill="black" />
          <circle cx="0.5"  cy="-1.0" r="0.02" fill="black" />
          <circle cx="1.0"  cy="-1.0" r="0.02" fill="black" />

          <circle cx="-1.0" cy="-0.5" r="0.02" fill="black" />
          <circle cx="-0.5" cy="-0.5" r="0.02" fill="black" />
          <circle cx="0.0"  cy="-0.5" r="0.02" fill="black" />
          <circle cx="0.5"  cy="-0.5" r="0.02" fill="black" />
          <circle cx="1.0"  cy="-0.5" r="0.02" fill="black" />

          <circle cx="-1.0" cy="0.0"  r="0.02" fill="black" />
          <circle cx="-0.5" cy="0.0"  r="0.02" fill="black" />
          <circle cx="0.0"  cy="0.0"  r="0.02" fill="red" />
          <circle cx="0.5"  cy="0.0"  r="0.02" fill="black" />
          <circle cx="1.0"  cy="0.0"  r="0.02" fill="black" />

          <circle cx="-1.0" cy="0.5"  r="0.02" fill="black" />
          <circle cx="-0.5" cy="0.5"  r="0.02" fill="black" />
          <circle cx="0.0"  cy="0.5"  r="0.02" fill="black" />
          <circle cx="0.5"  cy="0.5"  r="0.02" fill="black" />
          <circle cx="1.0"  cy="0.5"  r="0.02" fill="black" />

          <circle cx="-1.0" cy="1.0"  r="0.02" fill="black" />
          <circle cx="-0.5" cy="1.0"  r="0.02" fill="black" />
          <circle cx="0.0"  cy="1.0"  r="0.02" fill="black" />
          <circle cx="0.5"  cy="1.0"  r="0.02" fill="black" />
          <circle cx="1.0"  cy="1.0"  r="0.02" fill="black" />
        </g>

        <clock id="clock"/>
        <manager id="manager"/>
      </svg>
    </div>
    <script>
      Vue.component('clock', {
        data: function() {
          return {
            now: '',
          }
        },
        mounted: function() {
          requestAnimationFrame(this.tick);
        },
        methods: {
          tick: function() {
            this.now = moment();
            requestAnimationFrame(this.tick);
          },
        },
        template: `
          <text x="0" y="0" text-anchor="middle">{{ now }}</text>
        `,
      });

      Vue.component('manager', {
        data: function() {
          return {
            now: moment(),
            periods: [
              { start: '2019-08-06 00:00', end: '2019-08-07 00:00' },
              { start: '2019-08-06 00:00', end: '2019-08-06 12:00' },
              { start: '2019-08-06 09:00', end: '2019-08-06 10:00' },
              { start: '2019-08-06 09:10', end: '2019-08-06 09:20' },
              { start: '2019-08-06 09:11', end: '2019-08-06 09:12' },
            ],
          };
        },
        mounted: function() {
          requestAnimationFrame(this.tick);
        },
        methods: {
          arcs: function() {
            const arcs = [];

            for (const [i, period] of this.periods.entries()) {
              const startTime = moment(period['start']);
              const endTime = moment(period['end']);
              const value = (this.now - startTime) / (endTime - startTime);
              const r1 = 1 - i * (0.1 + 0.05) - 0.1;
              const r2 = r1 + 0.1;
              arcs.push({ value: value, r1: r1, r2: r2 });
            }

            return arcs;
          },
          tick: function() {
            this.now = moment();
            requestAnimationFrame(this.tick);
          }
        },
        template: `
          <g
            filter="url(#drop-shadow)"
            >
            <arc
              v-for="(arc, i) in arcs()"
              v-bind:key="i"
              v-bind:value="arc.value"
              v-bind:r1="arc.r1"
              v-bind:r2="arc.r2"/>
          </g>
        `,
      });

      Vue.component('arc', {
        props: [
          'value',
          'r1',
          'r2',
        ],
        computed: {
          d: function() {
            const value = Math.max(0, Math.min(0.99999999, this.value));
            const t1 = 0;
            const t2 = 2 * Math.PI * value;
            const large_arc_flag = value > 0.5 ? 1 : 0;
            const x_i1 =  this.r1 * Math.sin(t1);
            const y_i1 = -this.r1 * Math.cos(t1);
            const x_i2 =  this.r1 * Math.sin(t2);
            const y_i2 = -this.r1 * Math.cos(t2);
            const x_o2 =  this.r2 * Math.sin(t2);
            const y_o2 = -this.r2 * Math.cos(t2);
            const x_o1 =  this.r2 * Math.sin(t1);
            const y_o1 = -this.r2 * Math.cos(t1);
            return `M ${x_i1} ${y_i1}
                    A ${this.r1} ${this.r1} 0 ${large_arc_flag} 1 ${x_i2} ${y_i2}
                    L ${x_o2} ${y_o2}
                    A ${this.r2} ${this.r2} 0 ${large_arc_flag} 0 ${x_o1} ${y_o1}
                    L ${x_i1} ${y_i1}`;
          },
        },
        template: `
          <path
            v-bind:d="d"
            fill="tomato"
            fill-opacity="0.5"
            />
        `,
      });

      const app = new Vue({ el: '#app' });
    </script>
  </body>
</html>
